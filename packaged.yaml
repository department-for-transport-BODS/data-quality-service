AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'This SAM template deploys resources associated with the DQS (Data Quality
  Service) for BODS

  '
Parameters:
  DomainName:
    Type: String
    Description: The domain with which the service is associated, for use with SES
    Default: bus-data.dft.gov.uk
  Environment:
    Type: String
    Description: The environment into which the stack is being deployed
  ProjectName:
    Description: The name of the project
    Type: String
  RdsDbHostAddr:
    Type: String
    Default: ''
  RdsDbPort:
    Type: Number
    Default: 5432
Conditions:
  IsNotLocal:
    Fn::Not:
    - Fn::Equals:
      - Ref: Environment
      - local
Globals:
  Function:
    Architectures:
    - x86_64
    Runtime: python3.11
    Timeout: 135
    MemorySize: 512
    Tracing: Active
    KmsKeyArn:
      Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
    VpcConfig:
      Fn::If:
      - IsNotLocal
      - SubnetIds:
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/private-subnet-0}}'
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/private-subnet-1}}'
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/private-subnet-2}}'
        SecurityGroupIds:
        - Fn::GetAtt:
          - DqsCommonLambdaSecurityGroup
          - GroupId
      - Ref: AWS::NoValue
    Environment:
      Variables:
        PROJECT_ENV:
          Ref: Environment
        PROJECT_NAME:
          Ref: ProjectName
        POSTGRES_HOST:
          Fn::If:
          - IsNotLocal
          - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-endpoint}}'
          - Ref: RdsDbHostAddr
        POSTGRES_PORT:
          Ref: RdsDbPort
        POSTGRES_DB:
          Fn::If:
          - IsNotLocal
          - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-db-name}}'
          - postgres
        POSTGRES_USER:
          Fn::If:
          - IsNotLocal
          - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/pg-rw-user}}'
          - postgres
Resources:
  DqsCommonLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsNotLocal
    Properties:
      GroupDescription:
        Fn::Sub: Security group for ${ProjectName}-${Environment} DQS related lambda
          functions
      GroupName:
        Fn::Sub: ${ProjectName}-${Environment}-dqs-common-lambda
      SecurityGroupEgress:
      - IpProtocol: '-1'
        Description: Allow outbound connectivity to any
        CidrIp: '0.0.0.0/0'
      VpcId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/vpc-id}}'
      Tags:
      - Key: Name
        Value:
          Fn::Sub: ${ProjectName}-${Environment}-dqs-common-lambda
    Metadata:
      SamResourceId: DqsCommonLambdaSecurityGroup
  DqsCommonLambdaSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IsNotLocal
    Properties:
      GroupId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-sg-id}}'
      Description:
        Fn::Sub: Allow inbound connectivity from ${ProjectName}-${Environment}-dqs-common-lambda
      IpProtocol: tcp
      FromPort: 5432
      ToPort: 5432
      SourceSecurityGroupId:
        Fn::GetAtt:
        - DqsCommonLambdaSecurityGroup
        - GroupId
    Metadata:
      SamResourceId: DqsCommonLambdaSecurityGroupIngress
  BoilerplateLambdaLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName:
        Fn::Sub: ${ProjectName}-${Environment}-boilerplate-layer
      ContentUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/de4ad32108f1d194e91d1f9b9eed96a6
      CompatibleRuntimes:
      - python3.11
    Metadata:
      BuildMethod: python3.11
      SamResourceId: BoilerplateLambdaLayer
  DQSDeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-dead-letter-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
    Metadata:
      SamResourceId: DQSDeadLetterQueue
  FirstStopIsSetDownOnlyQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-first-stop-is-set-down-only-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: FirstStopIsSetDownOnlyQueue
  FirstStopIsSetDownOnlyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-first-stop-is-set-down-only-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: first_stop_is_set_down_only.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - FirstStopIsSetDownOnlyQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - FirstStopIsSetDownOnlyQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: FirstStopIsSetDownOnlyLambdaLogGroup
    Metadata:
      SamResourceId: FirstStopIsSetDownOnlyLambda
  FirstStopIsSetDownOnlyLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-first-stop-is-set-down-only-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: FirstStopIsSetDownOnlyLambdaLogGroup
  LastStopIsPickUpOnlyQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-last-stop-is-pickup-only-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: LastStopIsPickUpOnlyQueue
  LastStopIsPickUpOnlyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-last-stop-is-pickup-only-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: last_stop_is_pick_up_only.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - LastStopIsPickUpOnlyQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - LastStopIsPickUpOnlyQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: LastStopIsPickUpOnlyLambdaLogGroup
    Metadata:
      SamResourceId: LastStopIsPickUpOnlyLambda
  LastStopIsPickUpOnlyLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-last-stop-is-pickup-only-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: LastStopIsPickUpOnlyLambdaLogGroup
  FirstStopIsNotATimingPointQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: FirstStopIsNotATimingPointQueue
  FirstStopIsNotATimingPointLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: first_stop_is_not_a_timing_point.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - FirstStopIsNotATimingPointQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - FirstStopIsNotATimingPointQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: FirstStopIsNotATimingPointLambdaLogGroup
    Metadata:
      SamResourceId: FirstStopIsNotATimingPointLambda
  FirstStopIsNotATimingPointLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: FirstStopIsNotATimingPointLambdaLogGroup
  LastStopIsNotATimingPointQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: LastStopIsNotATimingPointQueue
  LastStopIsNotATimingPointLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: last_stop_is_not_a_timing_point.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - LastStopIsNotATimingPointQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - LastStopIsNotATimingPointQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: LastStopIsNotATimingPointLambdaLogGroup
    Metadata:
      SamResourceId: LastStopIsNotATimingPointLambda
  LastStopIsNotATimingPointLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: LastStopIsNotATimingPointLambdaLogGroup
  IncorrectNocQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-noc-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: IncorrectNocQueue
  IncorrectNocLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-noc-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: incorrect_noc.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - IncorrectNocQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - IncorrectNocQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: IncorrectNocLambdaLogGroup
    Metadata:
      SamResourceId: IncorrectNocLambda
  IncorrectNocLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-incorrect-noc-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: IncorrectNocLambdaLogGroup
  IncorrectStopTypeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-stop-type-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: IncorrectStopTypeQueue
  IncorrectStopTypeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-stop-type-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: incorrect_stop_type.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - IncorrectStopTypeQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - IncorrectStopTypeQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: IncorrectStopTypeLambdaLogGroup
    Metadata:
      SamResourceId: IncorrectStopTypeLambda
  IncorrectStopTypeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-incorrect-stop-type-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: IncorrectStopTypeLambdaLogGroup
  IncorrectLicenceNumberQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-licence-number-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: IncorrectLicenceNumberQueue
  IncorrectLicenceNumberLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-incorrect-licence-number-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: incorrect_licence_number.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - IncorrectLicenceNumberQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - IncorrectLicenceNumberQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: IncorrectLicenceNumberLambdaLogGroup
    Metadata:
      SamResourceId: IncorrectLicenceNumberLambda
  IncorrectLicenceNumberLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-incorrect-licence-number-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: IncorrectLicenceNumberLambdaLogGroup
  MissingStopQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-stop-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: MissingStopQueue
  MissingStopLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-stop-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: app.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - MissingStopQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - MissingStopQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: MissingStopLambdaLogGroup
    Metadata:
      SamResourceId: MissingStopLambda
  MissingStopLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-missing-stop-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: MissingStopLambdaLogGroup
  MissingBusWorkingNumberQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-bus-working-number-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: MissingBusWorkingNumberQueue
  MissingBusWorkingNumberLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-bus-working-number
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: missing_bus_working_number.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - MissingBusWorkingNumberQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - MissingBusWorkingNumberQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: MissingBusWorkingNumberLambdaLogGroup
    Metadata:
      SamResourceId: MissingBusWorkingNumberLambda
  MissingBusWorkingNumberLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-missing-bus-working-number-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: MissingBusWorkingNumberLambdaLogGroup
  DuplicateJourneyCodeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-duplicate-journey-code-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: DuplicateJourneyCodeQueue
  DuplicateJourneyCodeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-duplicate-journey-code-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: duplicate_journey_code.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - DuplicateJourneyCodeQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - DuplicateJourneyCodeQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: DuplicateJourneyCodeLambdaLogGroup
    Metadata:
      SamResourceId: DuplicateJourneyCodeLambda
  DuplicateJourneyCodeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-duplicate-journey-code-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: DuplicateJourneyCodeLambdaLogGroup
  StopNotFoundInNaptanQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-stop-not-found-in-naptan-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: StopNotFoundInNaptanQueue
  StopNotFoundInNaptanLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-stop-not-found-in-naptan-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: stop_not_found_in_naptan.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - StopNotFoundInNaptanQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - StopNotFoundInNaptanQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: StopNotFoundInNaptanLambdaLogGroup
    Metadata:
      SamResourceId: StopNotFoundInNaptanLambda
  StopNotFoundInNaptanLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-stop-not-found-in-naptan-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: StopNotFoundInNaptanLambdaLogGroup
  SameStopFoundMultipleTimesQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-same-stop-found-multiple-times-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: SameStopFoundMultipleTimesQueue
  SameStopFoundMultipleTimesLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-same-stop-found-multiple-times-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: app.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - SameStopFoundMultipleTimesQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - SameStopFoundMultipleTimesQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: SameStopFoundMultipleTimesLambdaLogGroup
    Metadata:
      SamResourceId: SameStopFoundMultipleTimesLambda
  SameStopFoundMultipleTimesLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-same-stop-found-multiple-times-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: SameStopFoundMultipleTimesLambdaLogGroup
  NoTimingPointMoreThan15MinsQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-no-timing-point-more-than-15-mins-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: NoTimingPointMoreThan15MinsQueue
  NoTimingPointMoreThan15MinsLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-no-timing-point-more-than-15-mins-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: no_timing_point_for_more_than_15_minutes.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - NoTimingPointMoreThan15MinsQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - NoTimingPointMoreThan15MinsQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: NoTimingPointMoreThan15MinsLogGroup
    Metadata:
      SamResourceId: NoTimingPointMoreThan15MinsLambda
  NoTimingPointMoreThan15MinsLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-no-timing-point-more-than-15-mins-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: NoTimingPointMoreThan15MinsLogGroup
  MissingJourneyCodeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-journey-code-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: MissingJourneyCodeQueue
  MissingJourneyCodeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-missing-journey-code-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: missing_journey_code.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - MissingJourneyCodeQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - MissingJourneyCodeQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: MissingJourneyCodeLambdaLogGroup
    Metadata:
      SamResourceId: MissingJourneyCodeLambda
  MissingJourneyCodeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-missing-journey-code-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: MissingJourneyCodeLambdaLogGroup
  GenerateDQSCSVReportQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-generate-csv-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
    Metadata:
      SamResourceId: GenerateDQSCSVReportQueue
  GenerateDQSCSVReportQueueLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-generate-dqs-csv-report-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/5d7f6ab48552502a50f027207915644f
      Handler: app.lambda_handler
      Environment:
        Variables:
          S3_BUCKET_DQS_CSV_REPORT:
            Fn::Sub: bodds-${Environment}-dqs-reports
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - GenerateDQSCSVReportQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            Resource:
              Fn::Sub: arn:aws:s3:::bodds-${Environment}-dqs-reports/*
          - Effect: Allow
            Action:
            - kms:Decrypt
            - kms:Encrypt
            - kms:GenerateDataKey
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - GenerateDQSCSVReportQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: GenerateDQSCSVReportLambdaLogGroup
    Metadata:
      SamResourceId: GenerateDQSCSVReportQueueLambda
  GenerateDQSCSVReportLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-generate-dqs-csv-report-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: GenerateDQSCSVReportLambdaLogGroup
  CancelledServiceAppearingActiveQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-cancelled-service-appearing-active-queue
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: CancelledServiceAppearingActiveQueue
  CancelledServiceAppearingActiveLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-cancelled-service-appearing-active-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: cancelled_service_incorrectly_appearing_as_active.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - CancelledServiceAppearingActiveQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - CancelledServiceAppearingActiveQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: CancelledServiceAppearingActiveLambdaLogGroup
    Metadata:
      SamResourceId: CancelledServiceAppearingActiveLambda
  CancelledServiceAppearingActiveLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-cancelled-service-appearing-active-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: CancelledServiceAppearingActiveLambdaLogGroup
  ServicedOrganisationOutOfDateQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName:
        Fn::Sub: ${ProjectName}-${Environment}-serviced-organisation-out-of-date
      KmsMasterKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      VisibilityTimeout: 300
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DQSDeadLetterQueue
          - Arn
        maxReceiveCount: 3
    Metadata:
      SamResourceId: ServicedOrganisationOutOfDateQueue
  ServicedOrganisationOutOfDateLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-serviced-organisation-out-of-date-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: serviced_organisation_out_of_date.lambda_handler
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - ServicedOrganisationOutOfDateQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - ServicedOrganisationOutOfDateQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: ServicedOrganisationOutOfDateLambdaLogGroup
    Metadata:
      SamResourceId: ServicedOrganisationOutOfDateLambda
  ServicedOrganisationOutOfDateLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-serviced-organisation-out-of-date-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: ServicedOrganisationOutOfDateLambdaLogGroup
  PipelineMonitorLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-pipeline-monitor-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/ee2549556743ad8b7ba17e935cc17563
      Handler: monitor.lambda_handler
      Events:
        MonitorLambdas:
          Type: Schedule
          Properties:
            Name:
              Fn::Sub: ${Environment}-${ProjectName}-pipeline-monitor-lambda-schedule
            Schedule: rate(2 minutes)
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
        - Ref: AWS::NoValue
      Environment:
        Variables:
          SQS_QUEUE_ENDPOINT:
            Fn::Sub: https://sqs.${AWS::Region}.amazonaws.com/
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action:
          - sqs:GetQueueUrl
          - sqs:SendMessage
          Resource:
            Fn::GetAtt:
            - GenerateDQSCSVReportQueue
            - Arn
        - Effect: Allow
          Action:
          - sqs:ListQueues
          Resource: '*'
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Encrypt
            - kms:GenerateDataKey
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      LoggingConfig:
        LogGroup:
          Ref: PipelineMonitorLambdaLogGroup
    Metadata:
      SamResourceId: PipelineMonitorLambda
  PipelineMonitorLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-pipeline-monitor-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: PipelineMonitorLambdaLogGroup
  DeadLetterQueueLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName:
        Fn::Sub: ${ProjectName}-${Environment}-dead-letter-queue-lambda
      CodeUri: s3://bodds-deployment-artefacts/dqs/releases/v1.1.43_hotfix-1-43-2/5c037a6bf7bbdc2e4cd8ef275617e3d8
      Handler: app.lambda_handler
      Environment:
        Variables:
          SOURCE_EMAIL:
            Fn::Sub: ${ProjectName}-monitoring.${Environment}@${DomainName}
          RECIPIENT_EMAIL: UK-DLInfrastructureIGH@KPMG.co.uk
          SQS_QUEUE_URL:
            Fn::GetAtt:
            - DQSDeadLetterQueue
            - QueueUrl
      Layers:
        Fn::If:
        - IsNotLocal
        - - Ref: BoilerplateLambdaLayer
          - Fn::Sub: arn:aws:lambda:${AWS::Region}:580247275435:layer:LambdaInsightsExtension:14
        - Ref: AWS::NoValue
      Policies:
      - AWSLambdaBasicExecutionRole
      - AWSLambdaVPCAccessExecutionRole
      - AWSXrayWriteOnlyAccess
      - AWSLambda_ReadOnlyAccess
      - CloudWatchLambdaInsightsExecutionRolePolicy
      - SESCrudPolicy:
          IdentityName:
            Ref: DomainName
      - SQSPollerPolicy:
          QueueName:
            Fn::GetAtt:
            - DQSDeadLetterQueue
            - QueueName
      - Fn::If:
        - IsNotLocal
        - Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - kms:Decrypt
            Resource:
              Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
        - Ref: AWS::NoValue
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-ro-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      - Fn::If:
        - IsNotLocal
        - Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/rds-proxy-rw-user-access-policy-arn}}'
        - AmazonRDSReadOnlyAccess
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - DQSDeadLetterQueue
              - Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup:
          Ref: DeadLetterQueueLambdaLogGroup
    Metadata:
      SamResourceId: DeadLetterQueueLambda
  DeadLetterQueueLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName:
        Fn::Sub: /aws/lambda/${ProjectName}-${Environment}-dead-letter-queue-lambda
      KmsKeyId:
        Fn::Sub: '{{resolve:ssm:/bodds/${Environment}/kms-key-arn}}'
      RetentionInDays: 30
    Metadata:
      SamResourceId: DeadLetterQueueLambdaLogGroup
