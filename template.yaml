AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  This SAM template deploys resources associated with the DQS (Data Quality Service) for BODS

Parameters:
  Environment:
    Type: String
    Description: The environment into which the stack is being deployed
  ProjectName:
    Description: The name of the project
    Type: String
  RdsDbHostAddr:
    Type: String
    Default: ''
  RdsDbPort:
    Type: Number
    Default: 5432
  VisibilityTimeout:
    Type: Number
    Description: Time allowed for processing of a SQS message by Lambda before returning to queue (s)
    Default: 90

Conditions:
  IsNotLocal: !Not [!Equals [!Ref Environment, 'local']]

Globals:
  Function:
    Architectures:
      - x86_64
    Runtime: python3.11
    Timeout: 60
    MemorySize: 128
    VpcConfig: !If
      - IsNotLocal
      -
        - SubnetIds: [!Sub '{{resolve:ssm:/bodds/${Environment}/private-subnets-test}}']
        - SecurityGroupIds:
          - !GetAtt DqsCommonLambdaSecurityGroup.GroupId
          - !Sub '{{resolve:ssm:/bodds/${Environment}/celeryworker-sg-id}}'
      - !Ref 'AWS::NoValue'
    Environment:
      Variables:
        PROJECT_ENV: !Ref Environment
        PROJECT_NAME: !Ref ProjectName
        POSTGRES_HOST: !If
            - IsNotLocal
            - !Sub '{{resolve:ssm:/bodds/${Environment}/rds-host}}'
            - !Ref RdsDbHostAddr
        POSTGRES_PORT: !Ref RdsDbPort
        POSTGRES_DB: !If
            - IsNotLocal
            - !Sub '{{resolve:ssm:/bodds/${Environment}/rds-db-name}}'
            - postgres
        POSTGRES_USER: !If
            - IsNotLocal
            - !Sub '{{resolve:ssm:/bodds/${Environment}/pg-rw-user}}'
            - postgres
        POSTGRES_PASSWORD_ARN: !If
            - IsNotLocal
            - !Sub '{{resolve:ssm:/bodds/${Environment}/pg-rw-password-arn}}'
            - postgres

Resources:
  #########################################
  #### GENERAL CONFIGURATION RESOURCES ####
  #########################################
  DqsCommonLambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: IsNotLocal
    Properties:
      GroupDescription: !Sub 'Security group for ${ProjectName}-${Environment} DQS related lambda functions'
      GroupName: !Sub '${ProjectName}-${Environment}-dqs-common-lambda'
      SecurityGroupEgress: 
        - IpProtocol: '-1'
          CidrIp: '0.0.0.0/0'
      VpcId: !Sub '{{resolve:ssm:/bodds/${Environment}/vpc-id}}'
      Tags:
        - Key: Name
          Value: !Sub '${ProjectName}-${Environment}-dqs-common-lambda'

  BoilerplateLambdaLayer: 
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub '${ProjectName}-${Environment}-boilerplate-layer'
      ContentUri: ./src/boilerplate
      CompatibleRuntimes:
        - python3.11
    Metadata:
      BuildMethod: python3.11

  #####################################
  #### FIRST STOP IS SET DOWN ONLY ####
  #####################################
  FirstStopIsSetDownOnlyQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-first-stop-is-set-down-only-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  FirstStopIsSetDownOnlyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-first-stop-is-set-down-only-lambda'
      CodeUri: ./src/template
      Handler: first_stop_is_set_down_only.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt FirstStopIsSetDownOnlyQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt FirstStopIsSetDownOnlyQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref FirstStopIsSetDownOnlyLambdaLogGroup

  FirstStopIsSetDownOnlyLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-first-stop-is-set-down-only-lambda'
      RetentionInDays: 30

  ###################################
  #### LAST STOP IS PICK UP ONLY ####
  ###################################
  LastStopIsPickUpOnlyQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-last-stop-is-pickup-only-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  LastStopIsPickUpOnlyLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-last-stop-is-pickup-only-lambda'
      CodeUri: ./src/template
      Handler: last_stop_is_pick_up_only.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt LastStopIsPickUpOnlyQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt LastStopIsPickUpOnlyQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref LastStopIsPickUpOnlyLambdaLogGroup

  LastStopIsPickUpOnlyLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-last-stop-is-pickup-only-lambda'
      RetentionInDays: 30

  ##########################################
  #### FIRST STOP IS NOT A TIMING POINT ####
  ##########################################
  FirstStopIsNotATimingPointQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  FirstStopIsNotATimingPointLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-lambda'
      CodeUri: ./src/template
      Handler: first_stop_is_not_a_timing_point.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt FirstStopIsNotATimingPointQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt FirstStopIsNotATimingPointQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref FirstStopIsNotATimingPointLambdaLogGroup

  FirstStopIsNotATimingPointLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-first-stop-is-not-a-timing-point-lambda'
      RetentionInDays: 30

  #########################################
  #### LAST STOP IS NOT A TIMING POINT ####
  #########################################
  LastStopIsNotATimingPointQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-lambda'
      VisibilityTimeout: !Ref VisibilityTimeout

  LastStopIsNotATimingPointLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-lambda'
      CodeUri: ./src/template
      Handler: last_stop_is_not_a_timing_point.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt LastStopIsNotATimingPointQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt LastStopIsNotATimingPointQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref LastStopIsNotATimingPointLambdaLogGroup

  LastStopIsNotATimingPointLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-last-stop-is-not-a-timing-point-lambda'
      RetentionInDays: 30

  #######################
  #### INCORRECT NOC ####
  #######################
  IncorrectNocQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-incorrect-noc-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  IncorrectNocLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-incorrect-noc-lambda'
      CodeUri: ./src/template
      Handler: incorrect_noc.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt IncorrectNocQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt IncorrectNocQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref IncorrectNocLambdaLogGroup

  IncorrectNocLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-incorrect-noc-lambda'
      RetentionInDays: 30

  #############################
  #### INCORRECT STOP TYPE ####
  #############################
  IncorrectStopTypeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-incorrect-stop-type-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  IncorrectStopTypeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-incorrect-stop-type-lambda'
      CodeUri: ./src/template
      Handler: incorrect_stop_type.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt IncorrectStopTypeQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt IncorrectStopTypeQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref IncorrectStopTypeLambdaLogGroup

  IncorrectStopTypeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-incorrect-stop-type-lambda'
      RetentionInDays: 30

  ##################################
  #### INCORRECT LICENSE NUMBER ####
  ##################################
  IncorrectLicenseNumberQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-incorrect-license-number-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  IncorrectLicenseNumberLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-incorrect-license-number-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt IncorrectLicenseNumberQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt IncorrectLicenseNumberQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref IncorrectLicenseNumberLambdaLogGroup

  IncorrectLicenseNumberLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-incorrect-license-number-lambda'
      RetentionInDays: 30

  ##############################
  #### MISSING JOURNEY CODE ####
  ##############################
  MissingJourneyCodeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-missing-journey-code_queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  MissingJourneyCodeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-missing-journey-code-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt MissingJourneyCodeQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt MissingJourneyCodeQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref MissingJourneyCodeLambdaLogGroup

  MissingJourneyCodeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-missing-journey-code-lambda'
      RetentionInDays: 30

  ######################
  #### MISSING STOP ####
  ######################
  MissingStopQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-missing-stop-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  MissingStopLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-missing-stop-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt MissingStopQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt MissingStopQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref MissingStopLambdaLogGroup

  MissingStopLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-missing-stop-lambda'
      RetentionInDays: 30

  ####################################
  #### MISSING BUS WORKING NUMBER ####
  ####################################
  MissingBusWorkingNumberQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-missing-bus-working-number-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  MissingBusWorkingNumberLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-missing-bus-working-number'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt MissingBusWorkingNumberQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt MissingBusWorkingNumberQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref MissingBusWorkingNumberLambdaLogGroup

  MissingBusWorkingNumberLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-missing-bus-working-number-lambda'
      RetentionInDays: 30

  ################################
  #### DUPLICATE JOURNEY CODE ####
  ################################
  DuplicateJourneyCodeQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-duplicate-journey-code_queue'
      VisibilityTimeout: !Ref VisibilityTimeout
      
  DuplicateJourneyCodeLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-duplicate-journey-code-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt DuplicateJourneyCodeQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt DuplicateJourneyCodeQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref DuplicateJourneyCodeLambdaLogGroup

  DuplicateJourneyCodeLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-duplicate-journey-code-lambda'
      RetentionInDays: 30

  ########################
  #### STOP NOT FOUND ####
  ########################
  StopNotFoundQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-stop-not-found-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  StopNotFoundLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-stop-not-found-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt StopNotFoundQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt StopNotFoundQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref StopNotFoundLambdaLogGroup

  StopNotFoundLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-stop-not-found-lambda'
      RetentionInDays: 30

  ########################################
  #### SAME STOP FOUND MULTIPLE TIMES ####
  ########################################
  SameStopFoundMultipleTimesQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub '${ProjectName}-${Environment}-same-stop-found-multiple-times-queue'
      VisibilityTimeout: !Ref VisibilityTimeout

  SameStopFoundMultipleTimesLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-${Environment}-same-stop-found-multiple-times-lambda'
      CodeUri: ./src/template
      Handler: app.lambda_handler
      Layers: !If 
        - IsNotLocal
        - [!Ref BoilerplateLambdaLayer]
        - !Ref 'AWS::NoValue'
      Policies:
        - 'AWSLambdaBasicExecutionRole'
        - 'AWSLambdaVPCAccessExecutionRole'
        - SQSPollerPolicy:
            QueueName: !GetAtt SameStopFoundMultipleTimesQueue.QueueName
        - !If
          - IsNotLocal
          - !Sub '{{resolve:ssm:/bodds/${Environment}/secrets-manager-policy-arn}}'
          - !Ref 'AWS::NoValue'
      Events:
        SQSTemplateTriggerEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt SameStopFoundMultipleTimesQueue.Arn
            BatchSize: 1
            ScalingConfig:
              MaximumConcurrency: 100
      LoggingConfig:
        LogGroup: !Ref SameStopFoundMultipleTimesLambdaLogGroup

  SameStopFoundMultipleTimesLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${ProjectName}-${Environment}-same-stop-found-multiple-times-lambda'
      RetentionInDays: 30

Outputs:
  Env:
    Description: 'Deployment Environment'
    Value: !Ref Environment